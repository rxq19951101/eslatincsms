<!DOCTYPE html>
<html>
<head>
    <title>测试占位符检测</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a2e;
            color: #fff;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        .success { color: #4ade80; }
        .error { color: #ff6b6b; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <h1>Admin 占位符检测测试</h1>
    
    <div class="test-case">
        <h3>测试1: 当前访问地址</h3>
        <div class="result" id="test1"></div>
    </div>
    
    <div class="test-case">
        <h3>测试2: API地址检测</h3>
        <div class="result" id="test2"></div>
    </div>
    
    <div class="test-case">
        <h3>测试3: 占位符检测</h3>
        <div class="result" id="test3"></div>
    </div>
    
    <div class="test-case">
        <h3>测试4: 验证函数测试</h3>
        <div class="result" id="test4"></div>
    </div>

    <script>
        // 模拟占位符检测逻辑
        const PLACEHOLDER_PATTERNS = [
            'your-server-ip', 'your-ip', 'your-domain', 'example.com',
            'localhost.example', 'placeholder', 'change-me', 'replace-me',
            'your-hostname', 'server-ip', 'server-address',
        ];
        
        function isPlaceholderUrl(url) {
            const lowerUrl = url.toLowerCase();
            return PLACEHOLDER_PATTERNS.some(pattern => lowerUrl.includes(pattern));
        }
        
        function isValidHostname(hostname) {
            if (isPlaceholderUrl(hostname)) return false;
            if (hostname === 'localhost' || hostname === '127.0.0.1') return true;
            const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (ipv4Regex.test(hostname)) {
                const parts = hostname.split('.').map(Number);
                return parts.every(part => part >= 0 && part <= 255);
            }
            const domainRegex = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            return domainRegex.test(hostname);
        }
        
        function getApiBase() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:9000';
            }
            
            if (!isValidHostname(hostname)) {
                return `${protocol}//${hostname}:9000`;
            }
            
            return `${protocol}//${hostname}:9000`;
        }
        
        function getApiBaseWithValidation() {
            const url = getApiBase();
            if (isPlaceholderUrl(url)) {
                return {
                    url,
                    error: `检测到占位符地址: ${url}`
                };
            }
            return { url };
        }
        
        // 测试1: 当前访问地址
        document.getElementById('test1').innerHTML = `
            <div>当前URL: <code>${window.location.href}</code></div>
            <div>Hostname: <code>${window.location.hostname}</code></div>
            <div>Protocol: <code>${window.location.protocol}</code></div>
            <div>Origin: <code>${window.location.origin}</code></div>
        `;
        
        // 测试2: API地址检测
        const apiBase = getApiBase();
        const isValid = isValidHostname(window.location.hostname);
        const isPlaceholder = isPlaceholderUrl(apiBase);
        
        document.getElementById('test2').innerHTML = `
            <div>检测到的API地址: <code>${apiBase}</code></div>
            <div class="${isValid ? 'success' : 'error'}">
                Hostname有效性: ${isValid ? '✅ 有效' : '❌ 无效'}
            </div>
            <div class="${isPlaceholder ? 'error' : 'success'}">
                占位符检测: ${isPlaceholder ? '❌ 包含占位符' : '✅ 无占位符'}
            </div>
        `;
        
        // 测试3: 占位符检测
        const testCases = [
            'your-server-ip',
            'your-ip',
            'localhost',
            '127.0.0.1',
            '47.236.134.99',
            'example.com',
            '192.168.1.100'
        ];
        
        let test3Html = '<table style="width:100%; border-collapse: collapse;">';
        test3Html += '<tr><th>Hostname</th><th>有效</th><th>占位符</th><th>API地址</th></tr>';
        testCases.forEach(hostname => {
            const valid = isValidHostname(hostname);
            const placeholder = isPlaceholderUrl(hostname);
            const apiUrl = `http://${hostname}:9000`;
            test3Html += `
                <tr>
                    <td><code>${hostname}</code></td>
                    <td class="${valid ? 'success' : 'error'}">${valid ? '✅' : '❌'}</td>
                    <td class="${placeholder ? 'error' : 'success'}">${placeholder ? '❌' : '✅'}</td>
                    <td><code>${apiUrl}</code></td>
                </tr>
            `;
        });
        test3Html += '</table>';
        document.getElementById('test3').innerHTML = test3Html;
        
        // 测试4: 验证函数测试
        const validation = getApiBaseWithValidation();
        document.getElementById('test4').innerHTML = `
            <div>API地址: <code>${validation.url}</code></div>
            ${validation.error ? `
                <div class="error">
                    <strong>错误:</strong> ${validation.error}
                </div>
            ` : `
                <div class="success">
                    ✅ 配置正确，无错误
                </div>
            `}
        `;
    </script>
</body>
</html>

