<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIé…ç½®æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #fff;
        }
        .test-case {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-case h3 {
            margin-top: 0;
            color: #5ac8fa;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: rgba(52, 199, 89, 0.2);
            border: 1px solid rgba(52, 199, 89, 0.5);
            color: #34c759;
        }
        .error {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid rgba(255, 59, 48, 0.5);
            color: #ff3b30;
        }
        .warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            color: #ffc107;
        }
        button {
            background: #5ac8fa;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        button:hover {
            background: #4ab8ea;
        }
        code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ APIé…ç½®æµ‹è¯•å·¥å…·</h1>
    <p>æµ‹è¯•APIåœ°å€æ£€æµ‹å’Œå ä½ç¬¦è¯†åˆ«åŠŸèƒ½</p>

    <div class="test-case">
        <h3>æµ‹è¯•1: å½“å‰ç¯å¢ƒæ£€æµ‹</h3>
        <p>æ£€æµ‹å½“å‰è®¿é—®çš„hostnameå’Œè‡ªåŠ¨ç”Ÿæˆçš„APIåœ°å€</p>
        <button onclick="testCurrentEnvironment()">è¿è¡Œæµ‹è¯•</button>
        <div id="test1-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-case">
        <h3>æµ‹è¯•2: å ä½ç¬¦æ£€æµ‹</h3>
        <p>æ¨¡æ‹Ÿå ä½ç¬¦hostnameï¼Œæµ‹è¯•æ˜¯å¦èƒ½æ­£ç¡®æ£€æµ‹</p>
        <button onclick="testPlaceholderDetection()">è¿è¡Œæµ‹è¯•</button>
        <div id="test2-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-case">
        <h3>æµ‹è¯•3: APIè¿æ¥æµ‹è¯•</h3>
        <p>æµ‹è¯•å®é™…APIè¿æ¥ï¼ˆéœ€è¦æœåŠ¡è¿è¡Œï¼‰</p>
        <button onclick="testApiConnection()">è¿è¡Œæµ‹è¯•</button>
        <div id="test3-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-case">
        <h3>æµ‹è¯•4: ç¯å¢ƒå˜é‡æ¨¡æ‹Ÿ</h3>
        <p>æ¨¡æ‹Ÿä¸åŒçš„ç¯å¢ƒå˜é‡é…ç½®</p>
        <button onclick="testEnvVariables()">è¿è¡Œæµ‹è¯•</button>
        <div id="test4-result" class="result" style="display:none;"></div>
    </div>

    <script type="module">
        // æ¨¡æ‹ŸAPIå·¥å…·å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
        const PLACEHOLDER_PATTERNS = [
            'your-server-ip', 'your-ip', 'your-domain', 'example.com',
            'localhost.example', 'placeholder', 'change-me', 'replace-me',
            'your-hostname', 'server-ip', 'server-address',
        ];

        function isPlaceholderUrl(url) {
            const lowerUrl = url.toLowerCase();
            return PLACEHOLDER_PATTERNS.some(pattern => lowerUrl.includes(pattern));
        }

        function isValidHostname(hostname) {
            if (isPlaceholderUrl(hostname)) return false;
            if (hostname === 'localhost' || hostname === '127.0.0.1') return true;
            const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (ipv4Regex.test(hostname)) {
                const parts = hostname.split('.').map(Number);
                return parts.every(part => part >= 0 && part <= 255);
            }
            const domainRegex = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            return domainRegex.test(hostname);
        }

        function getApiBase() {
            // æ¨¡æ‹Ÿç¯å¢ƒå˜é‡ï¼ˆå®é™…ä¸­ä»process.envè·å–ï¼‰
            const envApi = window.mockEnv?.NEXT_PUBLIC_API || window.mockEnv?.NEXT_PUBLIC_CSMS_HTTP;
            if (envApi) return envApi;

            if (typeof window !== 'undefined') {
                const hostname = window.location.hostname;
                const protocol = window.location.protocol;
                
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return 'http://localhost:9000';
                }
                
                if (!isValidHostname(hostname)) {
                    return `${protocol}//${hostname}:9000`;
                }
                
                return `${protocol}//${hostname}:9000`;
            }
            
            return 'http://localhost:9000';
        }

        function getApiBaseWithValidation() {
            const url = getApiBase();
            
            if (isPlaceholderUrl(url)) {
                let suggestedUrl = url;
                if (typeof window !== 'undefined') {
                    const currentHostname = window.location.hostname;
                    const protocol = window.location.protocol;
                    if (isValidHostname(currentHostname) && !isPlaceholderUrl(currentHostname)) {
                        suggestedUrl = `${protocol}//${currentHostname}:9000`;
                    }
                }
                return {
                    url: suggestedUrl,
                    error: `æ£€æµ‹åˆ°å ä½ç¬¦åœ°å€é…ç½®ã€‚è¯·è®¾ç½®ç¯å¢ƒå˜é‡ NEXT_PUBLIC_CSMS_HTTP=${suggestedUrl} å¹¶é‡å¯æœåŠ¡ã€‚`
                };
            }
            
            try {
                const urlObj = new URL(url);
                if (isPlaceholderUrl(urlObj.hostname)) {
                    return {
                        url,
                        error: `APIåœ°å€åŒ…å«å ä½ç¬¦: ${urlObj.hostname}ã€‚è¯·è®¾ç½®ç¯å¢ƒå˜é‡ NEXT_PUBLIC_CSMS_HTTP ä¸ºæ­£ç¡®çš„æœåŠ¡å™¨åœ°å€ã€‚`
                    };
                }
            } catch (e) {
                return {
                    url,
                    error: `APIåœ°å€æ ¼å¼é”™è¯¯: ${url}ã€‚è¯·æ£€æŸ¥é…ç½®ã€‚`
                };
            }
            
            return { url };
        }

        window.testCurrentEnvironment = function() {
            const result = document.getElementById('test1-result');
            result.style.display = 'block';
            
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            const origin = window.location.origin;
            
            const apiBase = getApiBase();
            const validation = getApiBaseWithValidation();
            
            let html = `<strong>å½“å‰è®¿é—®ä¿¡æ¯ï¼š</strong><br/>`;
            html += `Hostname: <code>${hostname}</code><br/>`;
            html += `Protocol: <code>${protocol}</code><br/>`;
            html += `Origin: <code>${origin}</code><br/><br/>`;
            
            html += `<strong>æ£€æµ‹åˆ°çš„APIåœ°å€ï¼š</strong><br/>`;
            html += `<code>${apiBase}</code><br/><br/>`;
            
            if (validation.error) {
                html += `<div class="error">âš ï¸ é…ç½®é”™è¯¯: ${validation.error}</div>`;
            } else {
                html += `<div class="success">âœ… APIåœ°å€æœ‰æ•ˆ</div>`;
            }
            
            result.innerHTML = html;
            result.className = 'result ' + (validation.error ? 'error' : 'success');
        };

        window.testPlaceholderDetection = function() {
            const result = document.getElementById('test2-result');
            result.style.display = 'block';
            
            const testCases = [
                'your-server-ip',
                'your-ip',
                'localhost',
                '127.0.0.1',
                '192.168.1.100',
                'example.com',
                '47.236.134.99'
            ];
            
            let html = '<strong>å ä½ç¬¦æ£€æµ‹æµ‹è¯•ï¼š</strong><br/><br/>';
            
            testCases.forEach(testHostname => {
                const isPlaceholder = isPlaceholderUrl(testHostname);
                const isValid = isValidHostname(testHostname);
                const status = isPlaceholder ? 'âŒ å ä½ç¬¦' : (isValid ? 'âœ… æœ‰æ•ˆ' : 'âš ï¸ æ— æ•ˆ');
                const className = isPlaceholder ? 'error' : (isValid ? 'success' : 'warning');
                
                html += `<div style="margin: 8px 0; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">`;
                html += `<code>${testHostname}</code> â†’ ${status}`;
                html += `</div>`;
            });
            
            result.innerHTML = html;
            result.className = 'result';
        };

        window.testApiConnection = async function() {
            const result = document.getElementById('test3-result');
            result.style.display = 'block';
            result.innerHTML = 'æ­£åœ¨æµ‹è¯•APIè¿æ¥...';
            result.className = 'result';
            
            const validation = getApiBaseWithValidation();
            
            if (validation.error) {
                result.innerHTML = `<div class="error">âš ï¸ ${validation.error}</div>`;
                result.className = 'result error';
                return;
            }
            
            try {
                const response = await fetch(`${validation.url}/api/v1/chargers`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = `<div class="success">âœ… APIè¿æ¥æˆåŠŸï¼<br/>è¿”å›äº† ${data.length || 0} æ¡å……ç”µæ¡©è®°å½•</div>`;
                    result.className = 'result success';
                } else {
                    result.innerHTML = `<div class="error">âŒ APIè¿”å›é”™è¯¯: HTTP ${response.status}</div>`;
                    result.className = 'result error';
                }
            } catch (error) {
                result.innerHTML = `<div class="error">âŒ è¿æ¥å¤±è´¥: ${error.message}<br/>APIåœ°å€: <code>${validation.url}/api/v1/chargers</code></div>`;
                result.className = 'result error';
            }
        };

        window.testEnvVariables = function() {
            const result = document.getElementById('test4-result');
            result.style.display = 'block';
            
            const scenarios = [
                { name: 'åœºæ™¯1: æœªè®¾ç½®ç¯å¢ƒå˜é‡', env: null },
                { name: 'åœºæ™¯2: è®¾ç½®æ­£ç¡®IP', env: { NEXT_PUBLIC_CSMS_HTTP: 'http://47.236.134.99:9000' } },
                { name: 'åœºæ™¯3: è®¾ç½®å ä½ç¬¦', env: { NEXT_PUBLIC_CSMS_HTTP: 'http://your-server-ip:9000' } },
                { name: 'åœºæ™¯4: è®¾ç½®localhost', env: { NEXT_PUBLIC_CSMS_HTTP: 'http://localhost:9000' } },
            ];
            
            let html = '<strong>ç¯å¢ƒå˜é‡æ¨¡æ‹Ÿæµ‹è¯•ï¼š</strong><br/><br/>';
            
            scenarios.forEach(scenario => {
                window.mockEnv = scenario.env;
                const apiBase = getApiBase();
                const validation = getApiBaseWithValidation();
                
                html += `<div style="margin: 12px 0; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 4px;">`;
                html += `<strong>${scenario.name}</strong><br/>`;
                if (scenario.env) {
                    html += `ç¯å¢ƒå˜é‡: <code>${JSON.stringify(scenario.env)}</code><br/>`;
                } else {
                    html += `ç¯å¢ƒå˜é‡: <code>æœªè®¾ç½®</code><br/>`;
                }
                html += `APIåœ°å€: <code>${apiBase}</code><br/>`;
                if (validation.error) {
                    html += `<div style="margin-top: 8px; padding: 8px; background: rgba(255, 59, 48, 0.2); border-radius: 4px; color: #ff3b30;">âš ï¸ ${validation.error}</div>`;
                } else {
                    html += `<div style="margin-top: 8px; padding: 8px; background: rgba(52, 199, 89, 0.2); border-radius: 4px; color: #34c759;">âœ… é…ç½®æœ‰æ•ˆ</div>`;
                }
                html += `</div>`;
            });
            
            window.mockEnv = null;
            result.innerHTML = html;
            result.className = 'result';
        };
    </script>
</body>
</html>

